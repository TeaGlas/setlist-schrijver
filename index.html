<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Liedjes Kiezer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label, select, input { display: block; margin-bottom: 1rem; }
    table { border-collapse: collapse; margin-top: 2rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
  </style>
</head>
<body>
  <h1>ðŸŽµ Liedjes Kiezer</h1>

  <input type="file" id="excelFile" accept=".xlsx" />

  <label>Aantal liedjes:
    <input type="number" id="totalSongs" min="1" required />
  </label>

  <label>Minimum aantal Nederlandse liedjes:
    <input type="number" id="minDutch" min="0" value="0" />
  </label>

  <label>Minimum aantal Engelse liedjes:
    <input type="number" id="minEnglish" min="0" value="0" />
  </label>

  <label>Minimum aantal Duitse liedjes:
    <input type="number" id="minGerman" min="0" value="0" />
  </label>

  <label>Kerstliedjes?
    <select id="includeChristmas">
      <option value="true" selected>Ja</option>
      <option value="false">Nee</option>
    </select>
  </label>

  <label>Hoeveel Kerstliedjes?
    <input type="number" id="christmasCount" style="display: none;" />
  </label>

  <label>Voorkeur voor boekje:
    <select id="bookletOption">
      <option value="any" selected>Maakt niet uit</option>
      <option value="one-from-each">Een liedje van elk boekje</option>
      <option value="only">Alleen van dit boekje (Vul hieronder in)</option>
    </select>
    <input type="number" id="onlyBooklet" placeholder="bijv. 1" style="display: none;" />
  </label>

  <button id="generate">Genereer lijst</button>

  <div id="output"></div>

  <script>
    function parseExcel(file, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        callback(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function pickNSongs(songs, n) {
      const copy = [...songs];
      const picked = [];
      while (n-- > 0 && copy.length) {
        const i = Math.floor(Math.random() * copy.length);
        picked.push(copy.splice(i, 1)[0]);
      }
      return [picked, copy];
    }

    document.getElementById('bookletOption').addEventListener('change', (e) => {
      document.getElementById('onlyBooklet').style.display = e.target.value === 'only' ? 'block' : 'none';
    });

    document.getElementById('includeChristmas').addEventListener('change', (e) => {
      document.getElementById('christmasCount').style.display = e.target.value === 'only' ? 'block' : 'none';
    });

    document.getElementById('generate').addEventListener('click', () => {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) return alert("Upload een Excel document");

      parseExcel(fileInput.files[0], (songs) => {
        const totalSongs = parseInt(document.getElementById('totalSongs').value);
        const minDutch = parseInt(document.getElementById('minDutch').value);
        const minGerman = parseInt(document.getElementById('minGerman').value);
        const minEnglish = parseInt(document.getElementById('minEnglish').value);
        const includeChristmas = document.getElementById('includeChristmas').value === 'true';
        const christmasCount = parseInt(document.getElementById('christmasCount').value);
        const bookletOption = document.getElementById('bookletOption').value;
        const onlyBooklet = document.getElementById('onlyBooklet').value;

        let pool = songs.map(s => ({
          number: s["Number"],
          title: s["Title"],
          artist: s["Artist"],
          language: s["Language"],
          christmas: ["true", "yes", "1"].includes((s["IsChristmas"] + '').toLowerCase()),
          booklet: s["Booklet"],
        }));

        const result = [];

        function popLanguage(lang, min) {
          const filtered = pool.filter(s => s.language.toLowerCase() === lang.toLowerCase());
          const [picked, remaining] = pickNSongs(filtered, min);
          result.push(...picked);
          pool = pool.filter(s => !picked.includes(s));
        }

        popLanguage("Dutch", minDutch);
        popLanguage("English", minEnglish);
        popLanguage("German", minGerman);

        if (!includeChristmas) pool = pool.filter(s => !s.christmas);
        if (includeChristmas && christmasCount > 0) {
          const christmasSongs = pool.filter(s => s.christmas);
          const [picked] = pickNSongs(christmasSongs, christmasCount);
          result.push(...picked);
          pool = pool.filter(s => !picked.includes(s));
        }

        if (bookletOption === 'only') {
          pool = pool.filter(s => String(s.booklet) === onlyBooklet);
        } else if (bookletOption === 'one-from-each') {
          const all = Array.from(new Set(pool.map(s => s.booklet)));
          all.forEach(b => {
            const fromB = pool.filter(s => s.booklet === b);
            const [picked] = pickNSongs(fromB, 1);
            result.push(...picked);
            pool = pool.filter(s => !picked.includes(s));
          });
        }

        const remaining = totalSongs - result.length;
        if (remaining > 0) {
          const [filler] = pickNSongs(pool, remaining);
          result.push(...filler);
        }

        const output = document.getElementById('output');
        if (!result.length) {
          output.innerHTML = '<p>Er konden geen liedjes geselecteerd worden met deze filters.</p>';
          return;
        }

        output.innerHTML = '<h2>Selected Songs:</h2>';
        const table = document.createElement('table');
        table.innerHTML = `<tr><th>Number</th><th>Title</th><th>Artist</th><th>Language</th><th>Christmas</th><th>Booklet</th></tr>` +
          result.map(s => `<tr>
            <td>${s.number}</td>
            <td>${s.title}</td>
            <td>${s.artist}</td>
            <td>${s.language}</td>
            <td>${s.christmas ? 'ðŸŽ„' : ''}</td>
            <td>${s.booklet}</td>
          </tr>`).join('');
        output.appendChild(table);
      });
    });
  </script>
</body>
</html>
