<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Liedjeskiezer</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2em;
      }
      label {
        display: block;
        margin: 0.5em 0;
      }
      #results {
        margin-top: 2em;
      }
      table, th, td {
        border: 1px solid gray;
        border-collapse: collapse;
        padding: 0.4em;
      }
    </style>
  </head>
  <body>
    <h1>Liedjeskiezer</h1>
    <form id="song_form">
      <label>
        Upload je Excelbestand:
        <input type="file" id="file_input" accept=".xlsx" required />
      </label>

      <label>
        Totaal aantal liedjes:
        <input type="number" name="total_songs" min="1" required />
      </label>

      <label>
        Minimaal aantal Nederlandse liedjes:
        <input type="number" name="min_dutch" min="0" value="0" />
      </label>

      <label>
        Minimaal aantal Engelse liedjes:
        <input type="number" name="min_english" min="0" value="0" />
      </label>

      <label>
        Minimaal aantal Duitse liedjes:
        <input type="number" name="min_german" min="0" value="0" />
      </label>

      <label>
        Kerstliedjes opnemen?
        <select name="include_christmas" id="include_christmas">
          <option value="no" selected>Nee</option>
          <option value="yes">Ja</option>
        </select>
      </label>

      <div id="christmas_count_input" style="display: none">
        <label>
          Aantal kerstliedjes:
          <input type="number" name="christmas_count" min="0" value="0" />
        </label>
      </div>

      <label>
        Boekoptie:
        <select name="booklet_option">
          <option value="any">Maakt niet uit</option>
          <option value="one_booklet">Alleen uit specifiek boekje</option>
          <option value="each">Aantal per boekje (zie hieronder)</option>
        </select>
      </label>

      <div id="booklet_only_input" style="display: none">
        <label>
          Nummer boekje:
          <input type="number" name="only_booklet_count" min="1" />
        </label>
      </div>

      <div id="booklet_each_input" style="display: none">
        <label>
          Aantal liedjes per boekje:
          <input type="number" name="each_booklet_count" min="1" />
        </label>
      </div>

      <label>
        Deze liedjes niet meenemen (gescheiden met komma's):
        <input
          type="text"
          name="exclude_numbers"
          placeholder="bijv. 3, 15, 22"
        />
      </label>

      <button type="submit">Genereer lijst</button>
    </form>

    <div id="results"></div>

    <script>
      document.getElementById("include_christmas").addEventListener("change", (e) => {
        document.getElementById("christmas_count_input").style.display =
          e.target.value === "yes" ? "block" : "none";
      });
    
      const bookletSelect = document.querySelector("select[name='booklet_option']");
      bookletSelect.addEventListener("change", (e) => {
        document.getElementById("booklet_only_input").style.display =
          e.target.value === "one_booklet" ? "block" : "none";
        document.getElementById("booklet_each_input").style.display =
          e.target.value === "each" ? "block" : "none";
      });
    
      document.getElementById("song_form").addEventListener("submit", async function (e) {
        e.preventDefault();
    
        const file = document.getElementById("file_input").files[0];
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
    
        const form = new FormData(e.target);
        const totalSongs = parseInt(form.get("total_songs"));
        const minDutch = parseInt(form.get("min_dutch") || "0");
        const minEnglish = parseInt(form.get("min_english") || "0");
        const minGerman = parseInt(form.get("min_german") || "0");
        const includeChristmas = form.get("include_christmas") === "yes";
        const christmasCount = includeChristmas ? parseInt(form.get("christmas_count") || "0") : 0;
        const bookletOption = form.get("booklet_option");
        const onlyBookletNumber = form.get("only_booklet_count");
        const eachBookletCount = parseInt(form.get("each_booklet_count") || "0");
        const excludeNumbers = (form.get("exclude_numbers") || "")
          .split(",")
          .map((x) => parseInt(x.trim()))
          .filter((x) => !isNaN(x));
    
        // Normalize and filter songs
        let songs = rows.map((row) => ({
          number: row["Number"],
          title: row["Title"],
          artist: row["Artist"],
          language: (row["Language"] || "").toLowerCase(),
          christmas: (row["IsChristmas"] + "").toLowerCase() === "true",
          booklet: row["Booklet"],
        }));
    
        songs = songs.filter((s) => !excludeNumbers.includes(s.number));
    
        // Filter helper
        const pickSongs = (filterFn, n, pool) => {
          const candidates = pool.filter(filterFn);
          const picked = candidates.sort(() => 0.5 - Math.random()).slice(0, n);
          return picked;
        };
    
        // Start building result
        let result = [];
        let remainingPool = [...songs];
    
        // 1. Boekoptie "alleen uit Ã©Ã©n specifiek boekje"
        if (bookletOption === "one_booklet" && onlyBookletNumber) {
          remainingPool = remainingPool.filter((s) => String(s.booklet) === String(onlyBookletNumber));
        }
    
        // 2. Verplichte filters
        const dutchSongs = pickSongs((s) => s.language === "dutch", minDutch, remainingPool);
        result.push(...dutchSongs);
        remainingPool = remainingPool.filter((s) => !dutchSongs.includes(s));
    
        const englishSongs = pickSongs((s) => s.language === "english", minEnglish, remainingPool);
        result.push(...englishSongs);
        remainingPool = remainingPool.filter((s) => !englishSongs.includes(s));
    
        const germanSongs = pickSongs((s) => s.language === "german", minGerman, remainingPool);
        result.push(...germanSongs);
        remainingPool = remainingPool.filter((s) => !germanSongs.includes(s));
    
        const christmasSongs = includeChristmas
          ? pickSongs((s) => s.christmas, christmasCount, remainingPool)
          : [];
        result.push(...christmasSongs);
        remainingPool = remainingPool.filter((s) => !christmasSongs.includes(s));
    
        // 3. Boekoptie "X liedjes per boekje"
        if (bookletOption === "each" && eachBookletCount > 0) {
          const uniqueBooklets = [...new Set(remainingPool.map((s) => s.booklet))];
          for (let b of uniqueBooklets) {
            const perBooklet = pickSongs((s) => s.booklet === b, eachBookletCount, remainingPool);
            result.push(...perBooklet);
            remainingPool = remainingPool.filter((s) => !perBooklet.includes(s));
          }
        }
    
        // 4. Vul op tot totaal (indien nodig)
        const stillNeeded = totalSongs - result.length;
        if (stillNeeded > 0) {
          const filler = remainingPool.sort(() => 0.5 - Math.random()).slice(0, stillNeeded);
          result.push(...filler);
        }
    
        // 5. Truncate if over (door dubbele filters)
        result = result.slice(0, totalSongs);
    
        // Output
        const table = `
          <h2>Resultaat (${result.length} liedjes)</h2>
          <table>
            <tr>
              <th>#</th><th>Titel</th><th>Artiest</th><th>Taal</th><th>Kerst</th><th>Boekje</th>
            </tr>
            ${result
              .map(
                (s) =>
                  `<tr><td>${s.number}</td><td>${s.title}</td><td>${s.artist}</td><td>${s.language}</td><td>${
                    s.christmas ? "ðŸŽ„" : ""
                  }</td><td>${s.booklet}</td></tr>`
              )
              .join("")}
          </table>`;
        document.getElementById("results").innerHTML = table;
      });
    </script>
  </body>
</html>
